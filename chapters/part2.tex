\chapter{Attitude control}
\section{Modelling}
This section provides a description of the dynamic and kinematic equations of motion which constitute the basis for further analysis and description of the forces and/or disturbances, which may affect a rigid body within LEO. The coordinate systems are defined first and then the model for the satellite is derived, based on rigid body dynamics and kinematics. 
%In order to control the distance between two or more satellites in orbit, a mathematical description of the governing equations should be derived. Since precious work have been made in previous projects, and all the measurements are available, in-depth analysis it is deemed not necessary. 
%
\subsection{Kinematics}
This section will provide the orbit-attitude determination of the satellite using quaternion representation. Since the differential drag control method is based on the rotation of the satellite in order to achieve the effective cross-sectional area, a notation with respect the collaborating frames have been obtained \fxnote{chapter 2}.

Quaternion parameterization it is deemed useful for the kinematic analysis of the satellite. Since the product of two quaternions gives the combined rotation, we shall specify the representation of rotation at time $t$ of the collaborating frames in order to derive the combined rotation at time $t+\Delta{t}$. The orientation of the rigid body at time $t$ is represented as $q(t)$ and at time $q(t+\Delta{t})$ is the resulting quaternion at time $t+\Delta{t}$. The orientation of the controller reference frame $\hat{x_{c}}, \hat{y_{c}}, \hat{z_{c}}$ at time $\Delta{t}$ with respect the orientation at time $t$ can be represented as $q_{c}(\Delta_{t}$, then the orientation of the satellite at $t+\Delta{t}$ can found as
%
\begin{flalign}
	q(t+\Delta{t}) = {q_{c}(\Delta_{t}) \otimes q(t)}
	\label{eq:quaternionproduct}
\end{flalign}
%
with the components of the rotation axis unit vector along $\hat{x_{c}}, \hat{y_{c}}, \hat{z_{c}}$ at time $t$ \cite{SADC} written as $[e_{x} e_{y} e_{z}]$ respectively and $\Delta{\Phi}$ the rotation at time $\Delta(t)$, the parameters of the controller quaternion can be written\cite{SADC} as 
%
\begin{flalign}
	q_{1c} = {e_{x}\sin\frac{\Delta\Phi}{2}}
	\label{eq:controllerquaternion1}
\end{flalign}
%
\begin{flalign}
	q_{2c} = {e_{y}\sin\frac{\Delta\Phi}{2}}
	\label{eq:controllerquaternion2}
\end{flalign}
%
\begin{flalign}
	q_{3c} = {e_{z}\sin\frac{\Delta\Phi}{2}}
	\label{eq:controllerquaternion3}
\end{flalign}
%
\begin{flalign}
	q_{4c} = {\cos\frac{\Delta\Phi}{2}}
	\label{eq:controllerquaternion4}
\end{flalign}
%
combining the  \eqref{eq:controllerquaternion1} - \eqref{eq:controllerquaternion4} with \eqref{eq:quaternionproduct} we obtain 
%
\begin{flalign}
	q(t+\Delta{t})
	= 
	\left\{\cos\frac{\Delta\Phi}{2} I_{(4x4)}+\sin\frac{\Delta\Phi}{2}
	\begin{bmatrix}
		0 &e_{z}&-e_{y}&e_{x} \\
		-e_{z}&0&e_{x}&e_{y}  \\ 
		e_{y}&-e_{x}&0&e_{z} \\
		-e_{x} &e_{y}&-e_{z}&0
	\end{bmatrix} 
\right \} q(t)
	\label{eq:quaternionmult}
\end{flalign}  
%
where I is the $4x4$ identity matrix. Using the small angle approximation \cite{SADC} for infinitesimal $\Delta(t)$ and denoted $\omega$ the instantaneous change in angular velocity it is obtained 
%
 \begin{flalign}
 	q(t+\Delta{t}) = \left[1 + \frac{1}{2} \Omega \Delta(t)\right]q(t)
 	\label{eq:controllerquaternionfinal}
 \end{flalign} 
with $\Omega$ be the skew symmetric matrix\cite{SADC} 
\begin{flalign}
	\Omega
	= 
	\begin{bmatrix}
		0& \omega_{z}& - \omega_{y}& \omega_{x} \\
		-\omega_{z}& 0&\omega_{1}& \omega_{x}  \\ 
		\omega_{y}& -\omega_{x}&0& \omega_{z} \\
		-\omega_{x}& -\omega_{y}& -\omega_{z}&0
	\end{bmatrix} 
	\label{eq:skewsymmetricmatrixquaternion}
\end{flalign}
%
the angle approximations where taken as $\cos\frac{\Delta\Phi}{2} \simeq 1$ and $\sin\frac{\Delta\Phi}{2}\simeq \frac{1}{2} \omega \Delta(t) $
%
\subsection{Dynamic Model}
In order to describe the behavior of the satellite a dynamic model based on reaction wheels and by using Euler's equation of motion has been derived.   
%
Euler's equation of motion describing the rotation of a rigid body relates the time derivative of angular momentum to the applied torques\cite{Biezl} and is given by: 
% 
\begin{flalign}
	\dot{L} = {N_{tot}- \omega }{\times {L}}
	\label{eq:eulerequation}
\end{flalign}
% 
where $N_{tot}$ represents all the external torques caused from the actuator and the disturbances, $\omega$ is the angular velocity of the satellite and $L$ is the total angular momentum of the satellite including reaction wheels, given by\cite{Biezl}:
%
\begin{flalign}
	{L} = {I_{s}}{\omega}+{h_{tot}}
	\label{eq:angularmomentum}
\end{flalign}
%
where $h_{tot}$ is the vector of the angular momentum of the wheels $[h_1 \ h_2 \ h_3]^{T}$, all seen in the satellites coordinate system and $I_{s}$ is the inertia matrix of the satellite.
%
Inserting the equation \eqref{eq:angularmomentum} into \eqref{eq:eulerequation} we obtain
%
\begin{flalign}
	{\frac{d}{dt}(I_{s}{\omega})+\dot{h}_{(tot)}} ={N_{tot}-\omega}     {\times  ({I_{s}}{\omega} +{h_{tot}})}
	\label{eq:angularmomentum2}
\end{flalign}
For three reaction wheels attached at the body coordinate system which are the axis roll, pitch and yaw, three equations shall be derived. The derivation of the three equations of motion along with the diagonal inertia matrix can be found in the \appref{chap:A}.
%
For the ease of notation, the cross product can be written as matrix operation using the $S()$ representing the skew symmetric matrix. Solving for $\dot{\omega}$ the dynamic equation can be written as 
%
\begin{flalign}
	{\dot{\omega}}={-I_{s}^{-1}S(\omega)I_{s}^{-1}\omega-I_{s}^{-1}S(\omega)h_{tot}-I_{s}^{-1}\dot{h}_{(tot)}+I_{s}^{-1}N_{tot}}
	\label{eq:angularmomentum3}
\end{flalign} 
%
The rate of change in angular momentum $\dot{h}_{(tot)}$ can be absorbed from the controller. This can be written as:
%
\begin{flalign}
	{\dot{h}_{(tot)}} ={-N{c}}
	\label{eq:rate of change}
\end{flalign}
%
where the negative sign denotes the absorbed momentum. The total torque from external disturbances can be written as $N_{dis}$. Rearranging, equation \eqref{eq:angularmomentum3} now reads 
%
\begin{flalign}
	{\dot{\omega}(t)} ={-I_{s}^{-1}S(\omega)I_{s}\omega(t)-I_{s}^{-1}S(\omega)h_{tot}+I_{s}^{-1}N_{c}(t)+I_{s}^{-1}N_{dis}(t)}
	\label{eq:angularmomentum4}
\end{flalign}
%
which constitute the dynamics of the satellite with three reaction wheels. At the final equation \eqref{eq:angularmomentum4} is shown the time dependency of the variables. 
%
\section{Disturbance Models}\label{sec:useCase} 
\subsection{Gravitational torque}
An unbalanced satellite in orbit is subjected to a torque due to the gravitational torque. Assumed that the earth is a point mass and the satellite is a rigid body, the gravitational torque can be estimated. Each infinitesimal element of the satellite of mass \textit{$dm_i$} is subjected to an infinitesimal force \textit{$dF_i$} that can be calculated thanks to Newton's law of universal gravitation.
\begin{flalign}
	dF_i = -G\frac{m_{earth}}{R_i^2}dm_i \cdot \hat{R_i}
	\label{eq:ref1}
\end{flalign}
where \textit{G} is the gravitational constant, \textit{$m_{earth}$} is the mass of the earth and \textit{$R_i^2$} is the vector from the Earth to the infinitesimal element of the satellite. \\
The moment of the gravitational force about the geometric center is calculated as the formula:
\begin{flalign}
	N_{gra} = \int_{sat} r_i \times dF_i 
	\label{eq:ref2}
\end{flalign}
with $r_i$ is the vector from the geometric center to the infinitesimal element. $r_i$ can be written as the sum of the vector from the geometric vector to the mass center $r_{g,m}$ and the vector from the mass center of the element $r_{m,i}$. Therefore, the expression of the gravitational torque is simplified:
\begin{flalign}
	N_{gra} &= \int_{sat} r_{g,m} \times dF_i + \int_{sat} r_{m,i} \times dF_i 
	\label{eq:ref3}
\end{flalign}
\[
= \int_{sat} r_{g,m} \times -G\frac{m_{earth}}{R_i^2}dm_i \cdot \hat{R_i} + \int_{sat} r_{m,i} \times -G\frac{m_{earth}}{R_i^2}dm_i \cdot \hat{R_i}
\]
We can assumed that $r_{m,g} << R_i$ and $R_i$ can be supposed constant and equals to the vector from the center of the earth to the geometric center of the satellite $R_{e,g}$. Thus, The second term is null by definition of the mass center.
\begin{flalign}
	\Rightarrow N_{gra} = G\frac{m_{sat} \cdot m_{earth}}{R_{e,g}^2} \cdot (\hat{R_i} \times r_{g,m})
	\label{eq:ref4}
\end{flalign}
The position of the center of mass was measured for the previous project and is eqals to [?;?;?] in the frame of the satellite. Therefore, $r_{g,m,i}$ can be expressed in the inertial frame as following:
\begin{flalign}
	[r_{g,m,i};0] = q_{i,s} \otimes [?;?;?.0] \otimes q_{i,s}*
	\label{eq:ref5}
\end{flalign}
where $q_{i,s}$ is the quaternion that represents the rotation of the satellite in the inertia frame and $\otimes$ is the quaternion multiplication. Thus, the moment of force can be calculated by this expression above.
\subsection{Solar radiation}
Tfhe surface of the CubeSat will absorb or reflect the solar radiation, nevertheless, these two situations will alter the CubeSat, which will produce a torque about the satellite center of mass(CoM). \cite{SADC}

The torque around CoM is given by:
\begin{flalign}
	N_{rad} = F_{rad} \times R_{CoM}
	\label{eq:tor}
\end{flalign}
where $F_{rad}$  is the solar radiation  and $R_{CoM}$ is the vector from the centre of mass to the geometric centre of radiation

The solar radiation $F_{rad}$ can be expressed as:
\begin{flalign}
	F_{rad} = C_{a} P A
	\label{eq:Pres}
\end{flalign}
where $C_{a}$ is the surfaceâ€™s reflectance: 0 for a perfect absorber, 1 for a perfect reflector,   while $P$ is the solar flux and  $A$ is the radiated area

The solar flux can be computed as follows:
\begin{flalign}
	P = \dfrac{F_s}{c}
	\label{eq:flux}
\end{flalign}
where $F_s$ is the mean solar energy and it is equal with 1358 $W/m^2$ and $c$ is the speed of light
\section{Attitude control design}
